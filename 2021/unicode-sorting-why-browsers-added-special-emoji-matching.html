<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Unicode sorting is hard &amp; why browsers added special emoji matching to regexp</title>
  <meta name="description" content="As I work on Zorex, an omnipotent regexp engine I have stumbled into a world of tales about why Unicode text sorting is so annoying in the modern day. Let’s talk about that.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/2021/unicode-sorting-why-browsers-added-special-emoji-matching">
  
  
  <link rel="alternate" type="application/rss+xml" title="Hexops&#39; devlog" href="/feed.xml">

  

  
  <meta property="og:title" content="Unicode sorting is hard &amp; why browsers added special emoji matching to regexp">
  <meta property="og:site_name" content="Hexops&#39; devlog">
  <meta property="og:url" content="/2021/unicode-sorting-why-browsers-added-special-emoji-matching">
  <meta property="og:description" content="As I work on Zorex, an omnipotent regexp engine I have stumbled into a world of tales about why Unicode text sorting is so annoying in the modern day. Let’s talk about that.">
  
  
    <meta property="og:image" content="https://raw.githubusercontent.com/hexops/website/master/media/png/square_logo.png">
  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Unicode sorting is hard &amp; why browsers added special emoji matc...">
  <meta name="twitter:description" content="As I work on Zorex, an omnipotent regexp engine I have stumbled into a world of tales about why Unicode text sorting is so annoying in the modern day. Let’s talk about that.">
  
  
    <meta name="twitter:image:src" content="https://raw.githubusercontent.com/hexops/website/master/media/png/square_logo.png">
  

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

    <div class="wrapper">

      <a class="site-title" href="/">
        <img alt="Hexops" class="logo color" src="https://raw.githubusercontent.com/hexops/media/main/logo.svg" style="height: 30px;">' devlog
      </a>
      <link href="/assets/font/stylesheet.css?v2" rel="stylesheet">
      <link rel="icon" sizes="any" type="image/svg+xml" href="https://raw.githubusercontent.com/hexops/website/master/media/svg/icon.svg">

      <script async defer data-domain="devlog.hexops.com" src="https://devlog.hexops.com/assets/opendata.js"></script>

      <nav class="site-nav">
        
          
          <a class="page-link" href="/about">About</a>
        
          
          <a class="page-link" href="/archives">Archives</a>
        
          
          <a class="page-link" href="https://github.com/hexops">GitHub</a>
        
      </nav>
  
    </div>
  
  </header>

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Unicode sorting is hard &amp; why browsers added special emoji matching to regexp</h1>
    
    <p class="post-meta"><time datetime="2021-06-27T00:00:00+00:00" itemprop="datePublished">Jun 27, 2021</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Stephen Gutekanst</span></span> •
  
    
    
      
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/unicode/">unicode,</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
        <a href="/categories/regex/">regex,</a>,
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
    
      
    
      
    
      
    
      
    
      
    
      
        <a href="/categories/zig/">zig</a>
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>As I work on <a href="https://github.com/hexops/zorex">Zorex, an omnipotent regexp engine</a> I have stumbled into a world of tales about why Unicode text sorting is so annoying in the modern day. Let’s talk about that.</p>

<ul>
  <li><a href="#why-ascii-sorting-is-not-enough">Why ASCII sorting is not enough</a></li>
  <li><a href="#twitters-emoji-problem-or-when-unicode-locale-aware-sorting-really-matters™">Twitter’s emoji problem, or when Unicode locale-aware sorting Really Matters™</a></li>
  <li><a href="#why-browsers-added-special-emoji-matching-to-regexp">Browsers added special emoji matching to regexp</a></li>
  <li><a href="#language-comparison">Language comparison</a>
    <ul>
      <li><a href="#javascript-collator-sorting-is-not-guaranteed-across-browsers">JavaScript Collator sorting is not guaranteed across browsers</a></li>
      <li><a href="#go-sortstrings-is-not-locale-aware">Go sort.Strings is not locale aware</a></li>
      <li><a href="#rust-vec-sorting-is-not-locale-aware">Rust Vec sorting is not locale aware</a></li>
      <li><a href="#swifts-default-is-not-locale-aware-but-unicode-support-is-notable">Swift’s default is not locale aware, but unicode support is notable</a></li>
      <li><a href="#zigs-ziglyph-package">Zig’s ziglyph package</a></li>
    </ul>
  </li>
  <li><a href="#why-is-localized-text-sorting-hard">Why is localized text sorting hard?</a></li>
  <li><a href="#webassembly-may-make-things-worse">WebAssembly may make things worse?</a></li>
</ul>

<h2 id="why-ascii-sorting-is-not-enough">Why ASCII sorting is not enough</h2>

<p>Perhaps you are sorting strings in JavaScript like this:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">words</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">Bears</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Beetle</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">kiss</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Similar</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Apples</span><span class="dl">'</span><span class="p">];</span>
<span class="nx">words</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
<span class="c1">// [ "Apples", "Bears", "Beetle", "Similar", "kiss" ]</span>
</code></pre></div></div>

<p>And that works pretty well, until someone translates it to German:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">words</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">Bären</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Käfer</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">küssen</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Ähnlich</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">Äpfel</span><span class="dl">'</span><span class="p">];</span>
<span class="nx">words</span><span class="p">.</span><span class="nx">sort</span><span class="p">();</span>
<span class="c1">// [ "Bären", "Käfer", "küssen", "Ähnlich", "Äpfel" ]</span>
</code></pre></div></div>

<p>The preferred alphabetical sorting would be <code class="language-plaintext highlighter-rouge">[ "Ähnlich", "Äpfel", "Bären", "Käfer", "küssen" ]</code> - <code class="language-plaintext highlighter-rouge">Array.sort</code> doesn’t do that.</p>

<p>That is because it is sorting lexicographically by byte values in the string, and not taking into account locales.</p>

<h2 id="twitters-emoji-problem---or-when-unicode-locale-aware-sorting-really-matters">Twitter’s emoji problem - or when Unicode locale-aware sorting Really Matters™</h2>

<p>Twitter is <a href="https://9to5google.com/2018/05/21/twitter-android-emoji-updates/">no stranger to issues with emojis</a>, but have you ever thought about how they check if a hashtag contains only legal characters and emojis? Regexp, of course!</p>

<p>You might think one could just use a regexp unicode character class, like <code class="language-plaintext highlighter-rouge">[\u{1f300}-\u{1f5ff}]</code> - but that only covers a single codepoint! Emojis and other text rely on combining multiple Unicode codepoints to compose <em>grapheme clusters</em> - and often what we see as a single visible character on our screen.</p>

<p>The full regexp needed to match all emojis with codepoints would be:</p>

<pre><code class="language-regexp">(?:\ud83e\uddd1\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1\ud83c\udffc|\ud83e\uddd1\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d
[102,816 characters omitted]
</code></pre>

<p>For your sake, I’ve omitted the other 102,816 characters of that regexp. You can view it here: https://regex101.com/r/2ia4m2/7</p>

<h2 id="browsers-added-special-emoji-matching-to-regexp">Browsers added special emoji matching to regexp</h2>

<p>Luckily for Twitter and others, ECMAScript’s <a href="https://github.com/tc39/proposal-regexp-unicode-property-escapes">TC39 proposal a few years back</a> extended the regexp engine to support Unicode property escapes for emojis and a few other Unicode properties so you can write e.g.:</p>

<pre><code class="language-regexp">\p{Emoji_Presentation}
</code></pre>

<p>Without packing several thousand bytes of Unicode data tables or regexp into your JS bundle.</p>

<h2 id="language-comparison">Language comparison</h2>

<p>As <a href="https://lemire.me/blog/2018/12/17/sorting-strings-properly-is-stupidly-hard/">Daniel Lemire said</a>: <em>sorting strings is stupidly hard</em>.</p>

<h3 id="javascript-collator-sorting-is-not-guaranteed-across-browsers">JavaScript Collator sorting is not guaranteed across browsers</h3>

<p>You may have found browser’s <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/localeCompare"><code class="language-plaintext highlighter-rouge">String.prototype.localCompare</code></a> or <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/Collator"><code class="language-plaintext highlighter-rouge">Intl.Collator</code></a> and they <strong>DO</strong> fix the issue<a href="https://ourcodeworld.com/articles/read/958/how-to-sort-an-array-of-strings-alphabetically-with-special-characters-properly-with-javascript">[1]</a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const words = ['Bären', 'Käfer', 'küssen', 'Ähnlich', 'Äpfel'];
words.sort(Intl.Collator().compare);
// [ "Ähnlich", "Äpfel", "Bären", "Käfer", "küssen" ]
</code></pre></div></div>

<p>(note, however, you may wish to use <code class="language-plaintext highlighter-rouge">Intl.Collator('de').compare</code> instead to sort according to German language customs)</p>

<p>However, beware that if you look at <a href="https://tc39.es/ecma402/#sec-collator-comparestrings">the ECMA spec</a> for this you will find:</p>

<blockquote>
  <p>It is <strong>recommended</strong> that the CompareStrings abstract operation be implemented following Unicode Technical Standard 10, Unicode Collation Algorithm […]</p>

  <p>Applications should not assume that the behaviour of the CompareStrings abstract operation for Collator instances with the same resolved options will remain the same for different versions of the same implementation.</p>
</blockquote>

<p>Although many browsers may produce similar sorting results - not all will. For one thing, not all locales are available across browsers.</p>

<p>Further, different browsers may choose to sort things differently. For example IE 11 sorting “co-op” after “coop” while other browsers do the opposite.<a href="https://stackoverflow.com/questions/33919257/sorting-strings-with-punctuation-using-intl-collator-is-inconsistent-across-brow">[2]</a></p>

<h2 id="go-sortstrings-is-not-locale-aware">Go sort.Strings is not locale aware</h2>

<p>It may be interesting to note that Go’s <code class="language-plaintext highlighter-rouge">sort.Strings</code> operates on byte comparisons, and has the same issue as JavaScript’s <code class="language-plaintext highlighter-rouge">Array.prototype.sort</code>:</p>

<pre><code class="language-Go">words := []string{"Bären", "Käfer", "küssen", "Ähnlich", "Äpfel"}	
sort.Strings(words)
// [Bären Käfer küssen Ähnlich Äpfel]
</code></pre>

<p>One can easily perform unicode code point (rune) sorting in Go, which would fix the above example - but note that rune sorting is not locale-aware, and importantly that <a href="https://www.reddit.com/r/golang/comments/o1o5hr/fyi_a_single_go_rune_is_not_the_same_as_a_single">a Go rune is not the same as a visible character</a> and would not take into account grapheme clusters.</p>

<p>For proper Unicode locale-aware sorting in Go, you need to use the Unicode Collation Algorithm via <a href="https://pkg.go.dev/golang.org/x/text/collate">golang.org/x/text/collate</a> but be sure to also apply normalization to your text first via <a href="https://pkg.go.dev/golang.org/x/text@v0.3.6/unicode/norm">golang.org/x/text/unicode/norm</a></p>

<h3 id="rust-vec-sorting-is-not-locale-aware">Rust Vec sorting is not locale aware</h3>

<p>A Rust <code class="language-plaintext highlighter-rouge">Vec</code> of strings implements sorting<a href="https://doc.rust-lang.org/std/primitive.str.html#impl-Ord">[3]</a> lexicographically by their byte values, consistent with Go’s <code class="language-plaintext highlighter-rouge">sort.Strings</code> and JavaScripts <code class="language-plaintext highlighter-rouge">Array.prototype.sort</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let mut vec = Vec::new();
vec.push("Bären");
vec.push("Käfer");
vec.push("küssen");
vec.push("Ähnlich");
vec.sort("Äpfel");
println!("{:?}", vec);
// ["Bären", "Käfer", "küssen", "Ähnlich", "Äpfel"]
</code></pre></div></div>

<p>Locale-aware sorting in Rust is provided <a href="https://github.com/google/rust_icu">by ICU4C bindings by Google, google/rust_icu</a> (note however, there have been a number of <a href="https://github.com/rust-lang/rust/issues/14656#issuecomment-45164318">vulnerabilities in the ICU4C library</a>) and there is ongoing work to implement internationalization in pure Rust as a safer alternative: <a href="https://github.com/unicode-org/icu4x">unicode-org/icu4x</a>.</p>

<h3 id="swifts-default-is-not-locale-aware-but-unicode-support-is-notable">Swift’s default is not locale aware, but unicode support is notable</h3>

<p>Swift remains consistent with other languages in sorting strings lexicographically by byte value:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">words</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Bären"</span><span class="p">,</span> <span class="s">"Käfer"</span><span class="p">,</span> <span class="s">"küssen"</span><span class="p">,</span> <span class="s">"Ähnlich"</span><span class="p">,</span> <span class="s">"Äpfel"</span><span class="p">]</span>
<span class="n">words</span><span class="o">.</span><span class="nf">sort</span><span class="p">()</span>
<span class="c1">// ["Bären", "Käfer", "küssen", "Ähnlich", "Äpfel"]</span>
</code></pre></div></div>

<p>However, it is notable that Swift includes locale sensitive sorting out of the box<a href="https://sarunw.com/posts/different-ways-to-sort-array-of-strings-in-swift/">[4]</a>:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">words</span> <span class="o">=</span> <span class="p">[</span><span class="s">"Bären"</span><span class="p">,</span> <span class="s">"Käfer"</span><span class="p">,</span> <span class="s">"küssen"</span><span class="p">,</span> <span class="s">"Ähnlich"</span><span class="p">,</span> <span class="s">"Äpfel"</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">sorted</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">sorted</span> <span class="p">{</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="k">in</span>    
    <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="nf">localizedStandardCompare</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">==</span> <span class="o">.</span><span class="n">orderedAscending</span>
<span class="p">}</span>
<span class="c1">// ["Ähnlich", "Äpfel", "Bären", "Käfer", "küssen"]</span>
</code></pre></div></div>

<p>It also seems quite notable just <a href="https://developer.apple.com/documentation/swift/string">how very unicode-aware the Swift documentation is on their String type</a>. Other languages could learn a thing or two here in educating developers.</p>

<h2 id="zigs-ziglyph-package">Zig’s ziglyph package</h2>

<p>Zig’s standard library is still quite under development, however it seems likely that major unicode functionality will be outside the stdlib.</p>

<p>Luckily, <a href="https://github.com/jecolon">@jecolon</a> in the Zig community is working on an excellent package for this: <a href="https://github.com/jecolon/ziglyph">ziglyph</a>.</p>

<p>I mention this because I’m a fan of the language and have recently begun contributing to that package; but otherwise Zig isn’t any different than other languages listed here aside from there being no real “default” way to sort strings from what I know.</p>

<h2 id="why-is-localized-text-sorting-hard">Why is localized text sorting hard?</h2>

<p>I believe there are a combination of factors at play:</p>

<ul>
  <li>Most languages leave Unicode locale-aware text sorting as an afterthought.</li>
  <li>Most developers don’t care enough to use Unicode, let alone implement locale-aware text sorting. Internationalization is always “that thing we’ll do if somebody complains” or an afterthought.</li>
  <li>It’s hard. It wasn’t until recently that we got semi-decent support for it across browsers, and what is there still leaves a lot to be desired.</li>
  <li>Many are still running into dated software, like NodeJS versions from ~2019 ish that <a href="https://github.com/nodejs/node/issues/19214">didn’t have full ICU support on by default</a>.</li>
</ul>

<h2 id="webassembly-may-make-things-worse">WebAssembly may make things worse?</h2>

<p>As a closing thought, I just want to hint at why I think WebAssembly will make things worse before they get better.</p>

<p>Whether your application is in Go and has it’s own Unicode Collation Algorithm (UCA) implementation, or Rust and uses bindings to the popular ICU4C library - one thing is going to remain true: it requires large data files to work.</p>

<p>The UCA algorithm depends on two quite large data table files to work:</p>

<ul>
  <li><a href="https://www.unicode.org/Public/9.0.0/ucd/UnicodeData.txt">UnicodeData.txt</a> for normalization, a step required before sorting can take place.</li>
  <li><a href="http://www.unicode.org/Public/UCA/12.0.0/allkeys.txt">allkeys.txt</a> for weighting certain text above others.</li>
  <li>And more, if you want truly locale-aware sorting and not just “the default” the UCA algorithm gives you.</li>
</ul>

<p>Together, these files can add up to over a half a megabyte.</p>

<p>While WASM languages could shell out to JavaScript browser APIs for collation, I suspect they won’t due to the lack of guarantees around those APIs.</p>

<p>A more likely scenario is languages continuing to leave locale-aware sorting as an optional, opt-in feature - that also makes your application larger.</p>

<p>I think this a worthwhile problem to solve, so I am working on <a href="https://github.com/jecolon/ziglyph/issues/3">compression algorithms for these files specifically</a> in Zig to reduce them to only a few tens of kilobytes.</p>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      <a alt="Twitter" href="https://twitter.com/slimsag""><img src="https://shields.io/badge/Twitter-follow-blue?logo=Twitter" class="color"></a>
&nbsp;
<a alt="RSS Follow" href="/feed.xml""><img src="https://shields.io/badge/RSS-follow-green?logo=RSS" class="color"></a>
&nbsp;
<a alt="License: CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0"><img src="https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg" class="color"></a>
&nbsp;
<a alt="Hexops on GitHub" href="https://github.com/hexops" class="github color" style="background-image: url(https://raw.githubusercontent.com/simple-icons/simple-icons/develop/icons/github.svg);line-height: 1;padding-left: 1.5rem;background-repeat: no-repeat;padding-top: .25rem;"> GitHub</a>
<br>
<br>
<a href="https://hexops.com"><img class="logo color" height="50px" alt="Hexops logo" src="https://raw.githubusercontent.com/hexops/media/main/logo.svg"></a>
<br>


&copy;  2021 Hexops
<link rel="me" href="mailto:support@hexops.com">
    </p>

  </div>

</footer>


  </body>

</html>
